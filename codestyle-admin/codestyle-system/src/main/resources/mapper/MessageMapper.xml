<?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="top.codestyle.admin.system.mapper.MessageMapper">
    <resultMap id="messageDetailMap" type="top.codestyle.admin.system.model.resp.message.MessageDetailResp">
        <id column="id" property="id" />
        <result property="users" column="users" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler" />
    </resultMap>

    <select id="selectMessagePage" resultType="top.codestyle.admin.system.model.resp.message.MessageResp">
        SELECT
            t1.id,
            t1.title,
            t1.type,
            t1.path,
            t1.scope,
            t1.create_time,
            t2.read_time IS NOT NULL AS isRead,
            t2.read_time AS readTime
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id <if test="query.userId != null">AND t2.user_id = #{query.userId}</if>
        WHERE t1.deleted = 0
        <if test="query.userId != null">
            <choose>
                <when test="_databaseId == 'mysql'">
                    AND (t1.scope = 1 OR (t1.scope = 2 AND JSON_CONTAINS(t1.users, CONCAT('"', #{query.userId}, '"'))))
                </when>
                <when test="_databaseId == 'pgsql'">
                    AND (t1.scope = 1 OR (t1.scope = 2 AND t1.users::jsonb @> jsonb_build_array(#{query.userId}::text)))
                </when>
            </choose>
        </if>
        <if test="query.title != null and query.title != ''">
            AND t1.title LIKE CONCAT('%', #{query.title}, '%')
        </if>
        <if test="query.type != null and query.type != ''">
            AND t1.type = #{query.type}
        </if>
        <if test="query.isRead != null">
            AND t2.read_time IS <if test="query.isRead">NOT</if> NULL
        </if>
        ORDER BY t1.create_time DESC
    </select>

    <select id="selectMessageById" resultMap="messageDetailMap">
        SELECT
            t1.id,
            t1.title,
            t1.content,
            t1.type,
            t1.path,
            t1.scope,
            t1.users,
            t1.create_time
        FROM sys_message AS t1
        WHERE t1.deleted = 0
          AND t1.id = #{id}
    </select>

    <select id="selectUnreadListByUserId" resultType="top.codestyle.admin.system.model.entity.MessageDO">
        SELECT
            t1.*
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id AND t2.user_id = #{userId}
        WHERE t1.deleted = 0
        <choose>
            <when test="_databaseId == 'mysql'">
                AND (t1.scope = 1 OR (t1.scope = 2 AND JSON_CONTAINS(t1.users, CONCAT('"', #{userId}, '"'))))
            </when>
            <when test="_databaseId == 'pgsql'">
                AND (t1.scope = 1 OR (t1.scope = 2 AND t1.users::jsonb @> jsonb_build_array(#{userId}::text) ))
            </when>
        </choose>
        AND t2.read_time IS NULL
    </select>

    <select id="selectUnreadCountByUserIdAndType" resultType="java.lang.Long">
        SELECT
            COUNT(1)
        FROM sys_message AS t1
        LEFT JOIN sys_message_log AS t2 ON t2.message_id = t1.id AND t2.user_id = #{userId}
        WHERE t1.deleted = 0
        <choose>
            <when test="_databaseId == 'mysql'">
                AND (t1.scope = 1 OR (t1.scope = 2 AND JSON_CONTAINS(t1.users, CONCAT('"', #{userId}, '"'))))
            </when>
            <when test="_databaseId == 'pgsql'">
                AND (t1.scope = 1 OR (t1.scope = 2 AND t1.users::jsonb @> jsonb_build_array(#{userId}::text) ))
            </when>
        </choose>
        AND t2.read_time IS NULL
        <if test="type != null">
            AND t1.type = #{type}
        </if>
    </select>
</mapper>

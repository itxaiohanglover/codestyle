<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.codestyle.admin.search.mapper.RemoteMetaMapper">
    
    <resultMap id="BaseResultMap" type="top.codestyle.admin.search.entity.RemoteMetaDO">
        <id column="id" property="id" />
        <result column="meta_json" property="metaJson" />
        <result column="group_id" property="groupId" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="deleted" property="deleted" />
        <result column="create_user" property="createUser" />
        <result column="update_user" property="updateUser" />
    </resultMap>
    
    <sql id="Base_Column_List">
        id, meta_json, create_time, update_time, deleted, create_user, update_user
    </sql>
    
    <!-- 查询所有未删除的远程元配置 -->
    <select id="selectAllActive" resultMap="BaseResultMap">
        SELECT id, meta_json, meta_json->>'$.groupId' as group_id,
               create_time, update_time, deleted, create_user, update_user
        FROM remote_meta_info
        WHERE deleted = 0
        ORDER BY update_time DESC
    </select>
    
    <!-- 根据ID查询远程元配置 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT id, meta_json, meta_json->>'$.groupId' as group_id,
               create_time, update_time, deleted, create_user, update_user
        FROM remote_meta_info
        WHERE id = #{id}
          AND deleted = 0
    </select>
    
    <!-- 根据group_id虚拟列查询远程元配置 -->
    <select id="selectByGroupId" resultMap="BaseResultMap">
        SELECT id, meta_json, meta_json->>'$.groupId' as group_id,
               create_time, update_time, deleted, create_user, update_user
        FROM remote_meta_info
        WHERE meta_json->>'$.groupId' = #{groupId}
          AND deleted = 0
        ORDER BY update_time DESC
    </select>
    
    <!-- 根据ID列表批量查询 -->
    <select id="selectByIds" resultMap="BaseResultMap">
        SELECT id, meta_json, meta_json->>'$.groupId' as group_id,
               create_time, update_time, deleted, create_user, update_user
        FROM remote_meta_info
        WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
          AND deleted = 0
    </select>
    
    <!-- 批量插入 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO remote_meta_info (id, meta_json, create_user)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.id}, #{item.metaJson}, #{item.createUser})
        </foreach>
    </insert>
</mapper>
# Canal + Kafka Docker Compose 配置
# 参考: https://help.aliyun.com/zh/apsaramq-for-kafka/cloud-message-queue-for-kafka/use-cases/use-canal-to-synchronize-data-from-a-mysql-database-to-message-queue-for-apache-kafka
# 
# 启动顺序：ZooKeeper -> Kafka -> Canal Server
# 确保Kafka完全就绪后再启动Canal，避免连接失败

networks:
  canal-kafka-network:
    driver: bridge

volumes:
  kafka-data:
  zookeeper-data:
  zookeeper-log:

services:
  # ZooKeeper服务（Kafka需要ZooKeeper）
  zookeeper:
    image: zookeeper:3.9
    container_name: canal-zookeeper
    restart: unless-stopped
    ports:
      - "2181:2181"
    environment:
      - ZOO_MY_ID=1
      - ZOO_SERVERS=server.1=0.0.0.0:2888:3888;2181
      - TZ=Asia/Shanghai
    volumes:
      - zookeeper-data:/data
      - zookeeper-log:/datalog
    networks:
      - canal-kafka-network
    healthcheck:
      # ZooKeeper健康检查：检查2181端口是否可访问
      test: ["CMD-SHELL", "nc -z localhost 2181 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Kafka服务
  canal-kafka:
    image: wurstmeister/kafka:2.13-2.7.0
    container_name: canal-kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://canal-kafka:9092,EXTERNAL://localhost:9094
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_NUM_PARTITIONS=3
      - TZ=Asia/Shanghai
      # 创建data-change topic（确保Canal启动前topic已存在）
      - KAFKA_CREATE_TOPICS=data-change:3:1
    volumes:
      - kafka-data:/kafka
    networks:
      - canal-kafka-network
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      # 检查Kafka broker是否就绪（先检查端口，再验证topic创建能力）
      # 使用kafka-topics.sh验证Kafka完全就绪（包括ZooKeeper连接和broker启动）
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1 || nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # Canal Server服务 - 使用v1.1.7版本（v1.1.5在Windows Docker上有段错误问题）
  canal-server:
    image: canal/canal-server:v1.1.7
    container_name: canal-sync-mysql-server
    restart: unless-stopped
    ports:
      - "11111:11111"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 挂载自定义配置文件和日志目录
    volumes:
      - ./conf/canal.properties:/home/admin/canal-server/conf/canal.properties:ro
      - ./conf/example/instance.properties:/home/admin/canal-server/conf/example/instance.properties:ro
      - ./logs:/home/admin/canal-server/logs
    environment:
      - TZ=Asia/Shanghai
    networks:
      - canal-kafka-network
    depends_on:
      canal-kafka:
        condition: service_healthy
      zookeeper:
        condition: service_healthy

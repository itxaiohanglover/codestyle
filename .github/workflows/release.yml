name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
        working-directory: ./codestyle-admin
      
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: codestyle-admin/codestyle-server/target/*.jar
          retention-days: 1

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
        working-directory: ./codestyle-admin-web
      
      - name: Build frontend
        run: pnpm build
        working-directory: ./codestyle-admin-web
      
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: codestyle-admin-web/dist
          retention-days: 1

  create-release:
    name: Create Release
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./artifacts/backend
      
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./artifacts/frontend
      
      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/backend/*.jar
          body: |
            ## CodeStyle ${{ steps.get_version.outputs.VERSION }}
            
            ### âœ¨ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            CodeStyleï¼ˆç èœ‚ï¼‰ä¼ä¸šçº§ä»£ç çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿæ–°ç‰ˆæœ¬å·²å‘å¸ƒï¼
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            - **åç«¯æœåŠ¡**: ä¸‹è½½ `codestyle-server-*.jar` æ–‡ä»¶
            - **å‰ç«¯èµ„æº**: è¯·ä» Artifacts ä¸‹è½½æˆ–è‡ªè¡Œæ„å»º
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            ```bash
            # è¿è¡Œåç«¯æœåŠ¡
            java -jar codestyle-server-*.jar
            
            # è®¿é—®åœ°å€
            http://localhost:8080
            ```
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/codestyle-team/codestyle/blob/${{ steps.get_version.outputs.VERSION }}/CHANGELOG.md)
            
            ### ğŸ“š æ–‡æ¡£
            
            - [README](https://github.com/codestyle-team/codestyle/blob/main/README.md)
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/codestyle-team/codestyle/blob/main/Codestyleé¡¹ç›®æ–‡æ¡£.md)
            - [å¿«é€Ÿå¼€å§‹æŒ‡å—](https://github.com/codestyle-team/codestyle/blob/main/README.md#å¿«é€Ÿå¼€å§‹)
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ [Issue](https://github.com/codestyle-team/codestyle/issues)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

